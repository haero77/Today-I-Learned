# ìƒˆë¡œìš´ ì—”í‹°í‹°ë¥¼ êµ¬ë³„í•˜ëŠ” ë°©ë²•

## ìƒˆë¡œìš´ ì—”í‹°í‹°ë¥¼ íŒë‹¨í•˜ëŠ” ê¸°ë³¸ ì „ëµ

- `save()` ë©”ì„œë“œ
  - ìƒˆë¡œìš´ ì—”í‹°í‹°ë©´ ì €ì¥(`persist`)
  - ìƒˆë¡œìš´ ì—”í‹°í‹°ê°€ ì•„ë‹ˆë©´ ë³‘í•©(`merge`)


- ìƒˆë¡œìš´ ì—”í‹°í‹°ë¥¼ íŒë‹¨í•˜ëŠ” ê¸°ë³¸ ì „ëµ
  - ì‹ë³„ìê°€ ê°ì²´ì¼ ë•Œ `null` ë¡œ íŒë‹¨.
  - ì‹ë³„ìê°€ ìë°” ê¸°ë³¸ íƒ€ì…ì¼ ë•Œ `0`ìœ¼ë¡œ íŒë‹¤.
  - `Persistable` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•´ì„œ íŒë‹¨ ë¡œì§ ë³€ê²½ ê°€ëŠ¥

<br>

### idëŠ” em.persist() ë¥¼ í•´ì•¼ ìƒì„±ì´ ëœë‹¤.

![img.png](image/img.png)

- **idëŠ” `em.persist()`ë¥¼ í•´ì•¼ ìƒì„±ëœë‹¤.**
  - `em.persist()`ê°€ ì´ë£¨ì–´ì§„ ë‹¤ìŒ `@GenerateValue`ê°€ idë¥¼ êº¼ë‚´ì„œ ì£¼ì…í•œë‹¤.

<br>

## GeneratedValue ì—†ì´ ì§ì ‘ idë¥¼ ë§Œë“ ë‹¤?

- ì‹¤ë¬´ì—ì„œ ê¸°ë³¸ì ìœ¼ë¡œ `@GeneratedValue`ë¥¼ ê¹”ê³  ë“¤ì–´ê°„ë‹¤.
- ë°ì´í„°ê°€ ë§ì•„ í…Œì´ë¸” ë¶„í• í•˜ê²Œ ë˜ë©´ì„œ ì„ì˜ë¡œ idë¥¼ ìƒì„±í•´ì•¼ í•˜ëŠ” ê²½ìš°ê°€ ìˆë‹¤.
  - ì´ëŸ´ ê²½ìš° `Persistable` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•´ì•¼í•œë‹¤.

![img_1.png](image/img_1.png)

```java
@Transactional
@Override
public <S extends T> S save(S entity) {
    if (entityInformation.isNew(entity)) {
        em.persist(entity);
        return entity;
    } else {
        return em.merge(entity);
    }
}
```

- ì§ì ‘ idë¥¼ ë§Œë“¤ê²Œ ë˜ë©´, `ìƒˆë¡œìš´ ì—”í‹°í‹°ë¥¼ íŒë‹¨í•˜ëŠ” ê¸°ë³¸ ì „ëµ`ì— ë”°ë¼ saveë¥¼ í•  ë•Œ `merge`ë¥¼ í•˜ê¸° ë•Œë¬¸ì—, SELECT ë‘ INSERT ì¿¼ë¦¬ê°€ ë‚˜ê°„ë‹¤.
- `merge()`ëŠ” **ìš°ì„  DBë¥¼ í˜¸ì¶œí•´ì„œ ê°’ì„ í™•ì¸**í•˜ê³ , DBì— ê°’ì´ ì—†ìœ¼ë©´ ìƒˆë¡œìš´ ì—”í‹°í‹°ë¡œ ì¸ì§€í•˜ë¯€ë¡œ ë§¤ìš° ë¹„íš¨ìœ¨ì ì´ë‹¤.
  - ğŸ‘‰ `Persistable` ì„ ì‚¬ìš©í•´ì„œ ìƒˆë¡œìš´ ì—”í‹°í‹° í™•ì¸ ì—¬ë¶€ë¥¼ ì§ì ‘ êµ¬í˜„í•˜ê²Œ í•˜ëŠ” ê²ƒì´ íš¨ê³¼ì ì´ë‹¤.

<br>

### Persistableì„ ì´ìš©í•˜ì—¬ isNew() êµ¬í˜„í•˜ê¸° 

```java
@EntityListeners(AuditingEntityListener.class)
@Entity
@NoArgsConstructor(access = AccessLevel.PROTECTED)
public class Item implements Persistable<String> {

    @Id
    private String id;
  
    @CreatedDate
    private LocalDateTime createdDate;
  
    public Item(String id) {
        this.id = id;
    }
  
    @Override
    public String getId() {
        return id;
    }
  
    // isNew ì˜¤ë²„ë¼ì´ë”©
    @Override
    public boolean isNew() {
        return createdDate == null;
    }

}
```

- `org.springframework.data.domain.Persistable` ì¸í„°í˜ì´ìŠ¤ì˜ `isNew()`ë¥¼ ì˜¤ë²„ë¼ì´ë”©í•´ì„œ, ê¸°ë³¸ ì „ëµì„ ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡ í•œë‹¤.
  - ì´ ë•Œ, `createdDate`ë¥¼ ì´ìš©í•˜ëŠ” ê²ƒì´ ê°„í¸í•˜ë‹¤.


<br>

### mergeëŠ” ì“°ì§€ ë§ë¼

- **ë°ì´í„° ë³€ê²½ì€ `ë³€ê²½ ê°ì§€`ë¥¼ ì‚¬ìš©í•˜ê³ , ë°ì´í„° ì €ì¥ì€ `em.persist()` ë¥¼ ì‚¬ìš©í•˜ë¼.**
- ì‹¤ì œë¡œ merge() ë¥¼ ì§ì ‘ ì“°ëŠ” ê²½ìš°ëŠ” ê±°ì˜ ì—†ë‹¤.
  - `merge`ëŠ” ì—”í‹°í‹°ê°€ `detached` ë˜ì—ˆì„ ë•Œ ì‚¬ìš©í•˜ëŠ”ë°, ì—”í‹°í‹°ê°€ detached ë˜ëŠ” ìƒí™©ì´ ê±°ì˜ ì—†ê¸° ë•Œë¬¸ì— ì§ì ‘ `merge`ë¥¼ ì‚¬ìš©í•  ì¼ì€ ì—†ë‹¤.  