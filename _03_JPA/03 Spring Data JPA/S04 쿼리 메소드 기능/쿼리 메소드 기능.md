# 4-1. ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„±

### ì¿¼ë¦¬ ë©”ì†Œë“œ ê¸°ëŠ¥ 3ê°€ì§€

- ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„±
- ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ JPA NamedQuery í˜¸ì¶œ
- `@Query` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•´ì„œ ë¦¬í¬ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤ì— ì¿¼ë¦¬ ì§ì ‘ ì •ì˜

### ì¿¼ë¦¬ ë©”ì†Œë“œ í•„í„° ì¡°ê±´

- https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.query-creation

### ìŠ¤í”„ë§ ë°ì´í„° JPAê°€ ì œê³µí•˜ëŠ” ì¿¼ë¦¬ ë©”ì†Œë“œ ê¸°ëŠ¥

- ì¡°íšŒ: 
  - find...By ,read...By ,query...By get...By
- COUNT
  - count ... by : `long`
- EXISTS
  - exists ... by : `boolean`
- ì‚­ì œ
  - delete ... by : `long`  
- DISTINCT
  - findDistinct, findMemberDistinctBy
- LIMIT 
  - findFirst3, findFirst, findTop, findTop3
  - https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.limit-query-result

### ì¡°ê±´ì´ ë„ˆë¬´ ë§ì•„ì§€ë©´? 

- ë³´í†µ ì¡°ê±´ 2ê°œê¹Œì§€ëŠ” ì¿¼ë¦¬ ë©”ì†Œë“œë¡œ ì§ ë‹¤.
- ì¡°ê±´ì´ ë” ì¶”ê°€ë˜ë©´ ë„ˆë¬´ ê¸¸ì–´ì§€ê¸° ë•Œë¬¸ì— `JPQL`ì„ ì´ìš©í•œë‹¤.

### Spring Data JPAì˜ í° ì¥ì : ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ì‹œì ì— ì—ëŸ¬ë°œìƒ

- ì¿¼ë¦¬ ë©”ì†Œë“œ ê¸°ëŠ¥ì€ ì—”í‹°í‹°ì˜ í•„ë“œëª…ì´ ë³€ê²½ë˜ë©´ ì¸í„°í˜ì´ìŠ¤ì— ì •ì˜í•œ ì´ë¦„ë„ ê¼­ í•¨ê»˜ ë³€ê²½í•´ì•¼í•œë‹¤.
- ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘í•˜ëŠ” ì‹œì ì— ì˜¤ë¥˜ê°€ ë‚œë‹¤.
- **ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ì‹œì ì— ì˜¤ë¥˜ë¥¼ ì¸ì§€**í•˜ëŠ” ê²ƒì´ Data JPAì˜ í° ì¥ì 


<br>

# 4-2. JPA NamedQuery

> _"ì‹¤ë¬´ì—ì„œ ì“¸ ì¼ ê±°ì˜ì—†ë‹¤. í¸í•˜ê²Œ ë“¤ì–´ë¼."_

### NamedQuery ì¥ì 

- NamedQuery ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì •ì  ì¿¼ë¦¬ì´ê¸° ë•Œë¬¸ì— ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ì‹œì ì— íŒŒì‹±ì„ í•´ì„œ ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¬ ìˆ˜ ìˆë‹¤.

<br>

# 4-3. @Query, ë¦¬í¬ì§€í† ë¦¬ ë©”ì†Œë“œì— ì¿¼ë¦¬ ì •ì˜í•˜ê¸°

> _"ì‹¤ë¬´ì—ì„œ ë§ì´ ì“°ëŠ” ê¸°ëŠ¥"_

### ê¸°ìˆ  ì„ íƒ ê¸°ì¤€

- ê°„ë‹¨í•œ ì¿¼ë¦¬ëŠ” `ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„±` ì‚¬ìš©.
- ì¡°ê¸ˆ ë³µì¡í•œ ì •ì  ì¿¼ë¦¬ëŠ” `@Query` ì‚¬ìš©.
- ë™ì  ì¿¼ë¦¬ëŠ” `Querydsl` ì‚¬ìš©. 

### ì¥ì : ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ì‹œì ì— ì—ëŸ¬ ë°œìƒ ê°€ëŠ¥  

- ì •ì  ì¿¼ë¦¬ ì´ê¸° ë•Œë¬¸ì— ë¡œë”©ì‹œì ì— íŒŒì‹±ì„ í•´ì„œ, ë¬¸ì œ ìˆìœ¼ë©´ ì—ëŸ¬ë¥¼ ë°œìƒì‹œì¼œì¤€ë‹¤.

# 4-4. @Query - ê°’, DTO ì¡°íšŒí•˜ê¸°

## ê°’ ì¡°íšŒí•˜ê¸°

```java
// ë‹¨ìˆœíˆ ê°’ í•˜ë‚˜ë¥¼ ì¡°íšŒ
@Query("select m.username from Member m")
List<String> findUsernameList();
```

## DTO ì¡°íšŒí•˜ê¸°

```java
// DTOë¡œ ì§ì ‘ ì¡°íšŒ
@Query("select new inf.datajpa.dto.MemberDto(m.id, m.username, t.name) "
    + "from Member m "
    + "join m.team t")
List<MemberDto> findMemberDto();
```

- ë‚´ë¶€ ì¡°ì¸ì€ `INNER JOIN` ì‚¬ìš©
  - `INNER` ëŠ” ìƒëµ ê°€ëŠ¥

<br>

# 4-5. íŒŒë¼ë¯¸í„° ë°”ì¸ë”© 

```java
select m from Member m where m.username = ?0 //ìœ„ì¹˜ ê¸°ë°˜ 
select m from Member m where m.username = :name //ì´ë¦„ ê¸°ë°˜
```

- ~~ìœ„ì¹˜ ê¸°ë°˜~~
  - _ìœ„ì¹˜ ê¸°ë°˜ì€ ê±°ì˜ ì‚¬ìš© ì•ˆ í•¨_
- **ì´ë¦„ ê¸°ë°˜** 

## ì»¬ë ‰ì…˜ íŒŒë¼ë¯¸í„° ë°”ì¸ë”© 

```java
@Query("select m from Member m where m.username in :names")
List<Member> findByNames(@Param("names") Collection<String> names);
```

- `Collection` íƒ€ì…ìœ¼ë¡œ IN ì ˆì„ ì§€ì›í•œë‹¤.

<br>

# 4-6. ë°˜í™˜ íƒ€ì…

- ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ìœ ì—°í•œ ë°˜í™˜ íƒ€ì… ì§€ì›

```java
List<Member> findByUsername(String name); //ì»¬ë ‰ì…˜
Member findByUsername(String name); //ë‹¨ê±´
Optional<Member> findByUsername(String name); //ë‹¨ê±´ Optional
```

### ì¡°íšŒ ê²°ê³¼ê°€ ë§ê±°ë‚˜ ì ì€ ê²½ìš°

- ì»¬ë ‰ì…˜
  - ê²°ê³¼ ì—†ìŒ: ë¹ˆ ì»¬ë ‰ì…˜ ë°˜í™˜
- ë‹¨ê±´ ì¡°íšŒ
  - ê²°ê³¼ ì—†ìŒ: null ë°˜í™˜
  - ê²°ê³¼ê°€ 2ê±´ ì´ìƒ: `javax.persistence.NonUniqueResultException` ì˜ˆì™¸ ë°œìƒ

<br>

# 4-7. ìˆœìˆ˜ JPA í˜ì´ì§•ê³¼ ì •ë ¬

- ì•„ë˜ ì¡°ê±´ì„ í˜ì´ì§• í•˜ê³  ì‹¶ë‹¤ê³  í•œë‹¤. 
  - ê²€ìƒ‰ ì¡°ê±´: ë‚˜ì´ê°€ 10ì‚´
  - ì •ë ¬ ì¡°ê±´: ì´ë¦„ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ 
  - í˜ì´ì§• ì¡°ê±´: ì²« ë²ˆì§¸ í˜ì´ì§€, í˜ì´ì§€ë‹¹ ë³´ì—¬ì¤„ ë°ì´í„°ëŠ” 3ê±´

```java
public List<Member> findByPage(int age, int offset, int limit) {
    return em.createQuery(
        "select m from Member m where m.age = :age order by m.username desc",
            Member.class
        )
        .setParameter("age", age)
        .setFirstResult(offset)
        .setMaxResults(limit)
        .getResultList();
}

public long totalCount(int age) {
    return em.createQuery("select count(m) from Member m where m.age = :age", Long.class)
      .setParameter("age", age)
      .getSingleResult();
}
```

<br>

# 4-8. ìŠ¤í”„ë§ ë°ì´í„° JPAì™€ ì •ë ¬

## í˜ì´ì§•ê³¼ ì •ë ¬ íŒŒë¼ë¯¸í„°

- `org.springframework.data.domain.Sort`: 
  - ì •ë ¬ ê¸°ëŠ¥
- `org.springframework.data.domain.Pageable`: 
  - í˜ì´ì§• ê¸°ëŠ¥(ë‚´ë¶€ì— `Sort` í¬í•¨) 
- íŒ¨í‚¤ì§€ë¥¼ ì˜ë³´ë©´ Data JPAê°€ ì•„ë‹Œ `Spring data`ì„ì„ ì•Œ ìˆ˜ ìˆë‹¤. (MongoDB ë“  ë­ë“  ì“¸ ìˆ˜ ìˆê²Œ í˜ì´ì§•ì„ ì¶”ìƒí™” í•´ë†“ì•˜ìŒ.)

## íŠ¹ë³„í•œ ë°˜í™˜ íƒ€ì…

**_ë°˜í™˜íƒ€ì…ì— ë”°ë¼ ì¿¼ë¦¬ê°€ ì–´ë–»ê²Œ ë‚˜ê°ˆì§€ ê²°ì •ëœë‹¤._**

- `org.springframework.data.domain.Page`
  - ì¶”ê°€ `COUNT` ì¿¼ë¦¬ë¦‚ í¬í•¨í•˜ëŠ” í˜ì´ì§•
  - ë‚´ë¶€ì—ì„œ ìµœì í™”ë¥¼ í•˜ë¯€ë¡œ COUNT ì¿¼ë¦¬ê°€ í•„ìš”í•˜ì§€ ì•Šìœ¼ë©´ í˜¸ì¶œí•˜ì§€ ì•ŠëŠ”ë‹¤.
    - https://www.inflearn.com/questions/32481
    - ìµœì í™” ë¡œì§ í´ë˜ìŠ¤: 
      - `org.springframework.data.repository.support.PageableExecutionUtils`
- `org.springframework.data.domain.Slice`
  - ì¶”ê°€ `COUNT` ì¿¼ë¦¬ì—†ì´ ë‹¤ìŒ í˜ì´ì§€ë§Œ í™•ì¸ ê°€ëŠ¥ 
    - ë‚´ë¶€ì ìœ¼ë¡œ `limit + 1` ì¡°íšŒ
  - total countê°€ í•„ìš” ì—†ëŠ” ê²½ìš° ì‚¬ìš©.
    - ëª¨ë°”ì¼ì˜ ë”ë³´ê¸° ê¸°ëŠ¥ ë“± (ë˜ëŠ” ë¬´í•œ ìŠ¤í¬ë¡¤)
  - ë°ì´í„°ê°€ 10ê°œ í•„ìš”í•œ ê²½ìš° 11ê°œë¥¼ ê°€ì ¸ì™€ì„œ, 10ê°œë§Œ ë³´ì—¬ì¤€ë‹¤.
    - ê·¸ ë‹¤ìŒ í˜ì´ì§€ëŠ” 11~20 ë³´ì—¬ì£¼ë©´ ëœë‹¤. (ì‹¤ì œë¡œëŠ” 21ê¹Œì§€ ê°€ì ¸ì˜´)
    - `+1` í•´ë´¤ëŠ”ë° ì—†ìœ¼ë©´ ê·¸ê²Œ ë§ˆì§€ë§‰ í˜ì´ì§€
- `List(Java Collection)`
  - ì¶”ê°€ `COUNT` ì¿¼ë¦¬ì—†ì´ ê²°ê³¼ë§Œ ë°˜í™˜

  
### Page ì˜ˆì œ

```java
// Repository
Page<Member> findAsPageByAge(int age, Pageable pageable);

// Test
@Test
void page() {
    // given
    memberRepository.save(new Member("member1", 10));
    memberRepository.save(new Member("member2", 10));
    memberRepository.save(new Member("member3", 10));
    memberRepository.save(new Member("member4", 10));
    memberRepository.save(new Member("member5", 10));

    int age = 10;
    // Pageable êµ¬í˜„ì²´
    PageRequest pageRequest = PageRequest.of(0, 3, Sort.by(Sort.Direction.DESC, "username"));

    //when
    Page<Member> page = memberRepository.findAsPageByAge(age, pageRequest);

    // then
    List<Member> content = page.getContent();
    long totalCount = page.getTotalElements();

    assertThat(content.size()).isEqualTo(3);
    assertThat(totalCount).isEqualTo(5);
    assertThat(page.getNumber()).isEqualTo(0);
    assertThat(page.getTotalPages()).isEqualTo(2); // 5 = 3 * '1' + '2'
    assertThat(page.isFirst()).isTrue();
    assertThat(page.hasNext()).isTrue();
}
```
```sql
select
    member0_.member_id as member_i1_0_,
    member0_.age as age2_0_,
    member0_.team_id as team_id4_0_,
    member0_.username as username3_0_ 
from
    member member0_ 
where
    member0_.age=10
order by
    member0_.username desc limit 3

# ì¶”ê°€ë¡œ ì‹¤í–‰ë˜ëŠ” COUNT ì¿¼ë¦¬ 
select
    count(member0_.member_id) as col_0_0_
from
    member member0_
where
    member0_.age=10
```

### Slice ì˜ˆì œ

```java
Slice<Member> findAsSliceByAge(int age, Pageable pageable);
```

```sql
select
  member0_.member_id as member_i1_0_,
  member0_.age as age2_0_,
  member0_.team_id as team_id4_0_,
  member0_.username as username3_0_
from
  member member0_
where
  member0_.age=10
order by
  member0_.username desc limit 4 # ì‚¬ì´ì¦ˆê°€ 3ì´ì§€ë§Œ +1 í•´ì„œ SELECT
  
# ì¶”ê°€ ì¹´ìš´íŠ¸ ì¿¼ë¦¬ ì—†ìŒ 
```

### List ì˜ˆì œ

```java
List<Member> findAsListByAge(int age, Pageable pageable);
```
```sql
select
    member0_.member_id as member_i1_0_,
    member0_.age as age2_0_,
    member0_.team_id as team_id4_0_,
    member0_.username as username3_0_ 
from
    member member0_ 
where
    member0_.age=10
order by
    member0_.username desc limit 3 # ì •í™•íˆ 3ê°œ limit 
    
# ì¹´ìš´íŠ¸ ì¿¼ë¦¬ ì—†ìŒ
```


## ì‹¤ë¬´ì—ì„œëŠ” COUNT ì¿¼ë¦¬ê°€ ë¬¸ì œë‹¤ â­ï¸â­ï¸

>  **_ì „ì²´ COUNT ì¿¼ë¦¬ëŠ” ë¬´ê²ë‹¤._** â­ï¸

- í˜ì´ì§•ì—ì„œ ì»¨í…ì¸  ê°€ì ¸ì˜¤ëŠ” ê²ƒì€ ë”± ì˜ë¼ì„œ ê°€ì ¸ì˜¤ëŠ” ê²ƒì´ê¸° ë•Œë¬¸ì— ìµœì í™”í•˜ê¸° ì‰½ë‹¤.
- total count ê°€ ë°ì´í„°ê°€ ë§ì•„ì§ˆìˆ˜ë¡ ë‹µì´ ì—†ì–´ì§„ë‹¤. 
- COUNT ì¿¼ë¦¬ë¥¼ ì˜ ì§œì•¼í•  ë•Œê°€ ìˆìŒ.
  - Member Team ì—ì„œ LEFT OUTER JOIN í•œë‹¤ê³  ê°€ì •.
  - total count í•  ë•ŒëŠ” JOIN í•  í•„ìš”ê°€ ì—†ë‹¤.
    - ë°ì´í„° ê°œìˆ˜ê°€ ê²°ê³¼ëŠ” ë˜‘ê°™ê¸° ë•Œë¬¸ì—.
    - COUNT ì¿¼ë¦¬ëŠ” LEFT OUTER JOINí•  í•„ìš”ê°€ ì—†ë‹¤.

### Count ì¿¼ë¦¬ ë¶„ë¦¬ ê¸°ëŠ¥

```java
@Query(value = "select m from Member m left join m.team t")
Page<Member> findWithoutCountQueryByAge(int age, Pageable pageable);
```
```sql
# ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” SELECT
select
  member0_.member_id as member_i1_0_,
  member0_.age as age2_0_,
  member0_.team_id as team_id4_0_,
  member0_.username as username3_0_
from
  member member0_
    left outer join
  team team1_
  on member0_.team_id=team1_.team_id
order by
  member0_.username desc limit ?

# COUNT - JOINì´ ê»´ìˆë‹¤. 
select
  count(member0_.member_id) as col_0_0_ 
from
  member member0_ 
left outer join
  team team1_ 
      on member0_.team_id=team1_.team_id
```

- COUNT ì¿¼ë¦¬ ë¶„ë¦¬ê°€ ì•ˆ ëœ ê²½ìš°, 
  - **COUNT ì¿¼ë¦¬ì—ë„ JOIN ì„ ìˆ˜í–‰í•˜ëŠ” ë¬¸ì œê°€ ë°œìƒ**
  - JOIN ìì²´ê°€ ë¹„ì‹¸ê³ , **ì–´ì°¨í”¼ `LEFT OUTER JOIN`ì˜ ê²°ê³¼ë‚˜ ê·¸ëƒ¥ ì™¼ìª½ í…Œì´ë¸”ì˜ SELECT ê²°ê³¼ê°€ ê°™ê¸° ë•Œë¬¸ì— ë§¤ìš° ë¹„íš¨ìœ¨ì ** 

```java
@Query(value = "select m from Member m left join m.team t",
    countQuery = "select count(m) from Member m")
Page<Member> findWithCountQueryByAge(int age, Pageable pageable);
```

```sql
# COUNT ì¿¼ë¦¬ì— JOINì´ ì—†ì–´ì§
select
    count(member0_.member_id) as col_0_0_ 
from
    member member0_
```

- `countQuery`ë¥¼ í†µí•´, COUNT ì¿¼ë¦¬ ìˆ˜í–‰ ì‹œ JOINë¬¸ì„ ì—†ì•¤ë‹¤.

### SORT ì¡°ê±´ì´ ë³µì¡í•´ì§€ë©´ ê·¸ëƒ¥ JPQL ì— ì§ì ‘ ì¡°ê±´ ì‘ì„±í•˜ë©´ ëœë‹¤ â­ï¸

```java
PageRequest pageRequest = 
        PageRequest.of(0, 3, Sort.by(Sort.Direction.DESC, "username"));
```

- ì§€ê¸ˆì€ ì •ë ¬ ì¡°ê±´ì´ ë‹¨ìˆœí•´ì„œ ê´œì°®ì§€ë§Œ, ì‹¤ë¬´ì—ì„œ ë” ë³µì¡í•œ ê²½ìš° ë§ë‹¤.
  - ğŸ‘‰ JPQLë¡œ ì§ì ‘ ì •ë ¬ ì¡°ê±´ ì‘ì„±í•˜ë©´ ëœë‹¤.

## `Page<Entity>` ë§ê³  `Page<Dto>` ë¥¼ ë¦¬í„´í•˜ì

- ì—”í‹°í‹°ê°€ ë…¸ì¶œë˜ë©´ ë³€ê²½ì— ì·¨ì•½.
- `Page.map()` ì„ ì‚¬ìš©í•˜ì.

```java
Page<Member> page = memberRepository.findWithoutCountQueryByAge(age, pageRequest);
Page<MemberDto> toMap = page.map(member -> new MemberDto(member.getId(), member.getUsername(), null));
```

<br>

# 4-9 ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬

- ì¼ë°˜ì ìœ¼ë¡œ íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œì ì— ë”í‹° ì²´í‚¹ìœ¼ë¡œ UPDATE ì¿¼ë¦¬ê°€ ë‚˜ê°
  - í•œ ê±´ í•œ ê±´ì”© UPDATE í•œë‹¤. 
  - ì°¨ë¼ë¦¬ UPDATE í•œ ë²ˆìœ¼ë¡œ ìˆ˜ì •í•˜ëŠ”ê²Œ ë” íš¨ìœ¨ì ì¼ ìˆ˜ ìˆìŒ(=`ë²Œí¬ì„± ìˆ˜ì •ì¿¼ë¦¬`)

## ìˆœìˆ˜ JPA ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬

```java
// MemberJpaRepository
public int bulkAgePlus(int age) {
    return em.createQuery(
            "update Member m set m.age = m.age + 1 "
                + "where m.age >= :age")
        .setParameter("age", age)
        .executeUpdate();
}
```

```java
// Test Code
@Test
void bulkUpdate() {
    // given
    memberJpaRepository.save(new Member("member1", 10));
    memberJpaRepository.save(new Member("member2", 19));
    memberJpaRepository.save(new Member("member3", 20));
    memberJpaRepository.save(new Member("member4", 21));
    memberJpaRepository.save(new Member("member5", 40));

    // when
    int resultCount = memberJpaRepository.bulkAgePlus(20);

    // then
    assertThat(resultCount).isEqualTo(3);
}
```

## Spring Data JPA ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬

```java
// MemberRepository
@Modifying
@Query("update Member m set m.age = m.age + 1 where m.age >= :age")
int bulkAgePlus(@Param("age") int age);
```

- ë²Œí¬ì„± ìˆ˜ì •, ì‚­ì œ ì¿¼ë¦¬ëŠ” `@Modifying` ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš©
  - ì‚¬ìš©í•˜ì§€ ì•Šì„ ì‹œ `org.hibernate.hql.internal.QueryExecutionRequestException: Not supported for
    DML operations` ì˜ˆì™¸ ë°œìƒ

## JPAì—ì„œì˜ ë²Œí¬ì„± ì¿¼ë¦¬ì˜ ì£¼ì˜ì : ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¬´ì‹œí•˜ê³  ì¿¼ë¦¬ ì‹¤í–‰ â­ï¸

```java
@Test
@Rollback(value = false)
void bulkUpdate() {
    // given
    memberRepository.save(new Member("member1", 10));
    memberRepository.save(new Member("member2", 19));
    memberRepository.save(new Member("member3", 20));
    memberRepository.save(new Member("member4", 21));
    memberRepository.save(new Member("member5", 40));

    // when
    int resultCount = memberRepository.bulkAgePlus(20);

    /**
     * JPA ë²Œí¬ì„± ì¿¼ë¦¬ ì£¼ì˜ì  : DBì™€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ë‹¤ë¥´ë‹¤.
     */
    Member member5 = memberRepository.findByUsername("member5").get(0);
    System.out.println("member5 = " + member5);

    // then
    assertThat(resultCount).isEqualTo(3);
}
```

```java
// ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸
member5 = Member(id=5, username=member5, age=40)
```

![image](https://github.com/haero77/Today-I-Learned/assets/65555299/9f9890d5-0513-4a4b-9972-d52529bac04e)

- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œëŠ” `member5` ê°€ 40ì‚´, but DBì—ëŠ” 41ì‚´
- **ë²Œí¬ ì—°ì‚°ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ë¬´ì‹œí•˜ê³  ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•œë‹¤.**
  - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” ì´ ì‚¬ì‹¤ë„ ëª¨ë¥´ê³ , ê²°êµ­ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë‘ DBì˜ ë°ì´í„°ê°€ ìƒê¹€

**ğŸ‘‰ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™” í•´ì¤Œìœ¼ë¡œì¨ í•´ê²°**

### ë²Œí¬ì„± ì¿¼ë¦¬ ì´í›„ì— ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í•˜ì

```java
@Test
@Rollback(value = false)
void bulkUpdate() {
    
    ...
	
    // when
    int resultCount = memberRepository.bulkAgePlus(20);
    em.flush();
    em.clear(); //  

    ...
}
```

```java
// ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” ì´í›„
member5 = Member(id=5, username=member5, age=41)
```

- JPQL ì‚¬ìš©í•  ë•Œ ì–´ì°¨í”¼ `flush` ê°€ í˜¸ì¶œëœë‹¤.

### @Modifying(clearAutomatically = true)

```java
@Modifying(clearAutomatically = true)
@Query("update Member m set m.age = m.age + 1 where m.age >= :age")
int bulkAgePlus(@Param("age") int age);
```

- `@Modifying(clearAutomatically = true)` ë¥¼ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ ë²Œí¬ì„± ì¿¼ë¦¬ ì‹¤í–‰ í›„ ìë™ìœ¼ë¡œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”.

### ë²Œí¬ ì—°ì‚° ì‹œ ê¶Œì¥ ë°©ì•ˆ

1. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ê°€ ì—†ëŠ” ìƒíƒœì—ì„œ ë²Œí¬ ì—°ì‚°ì„ ë¨¼ì € ì‹¤í–‰í•œë‹¤.
2. ë¶€ë“ì´í•˜ê²Œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ê°€ ìˆëŠ” ìƒíƒœë©´ ë²Œí¬ ì—°ì‚° ì§í›„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í•œë‹¤. 

> ì°¸ê³ : `MyBatis`, `JdbcTemplate` ì„ ê°™ì´ ì‚¬ìš©í•  ë•Œë„ JPAëŠ” ì´ë¥¼ ì•Œì•„ì°¨ë¦´ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ **ì—¬ëŸ¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ê°™ì´ ì“°ëŠ” ê²½ìš°ì—ëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í•´ì¤˜ì•¼í•¨ì„ ê¸°ì–µí•˜ì.** 