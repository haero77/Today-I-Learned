# ìˆ˜ì •, ì‚­ì œ ë²Œí¬ ì—°ì‚°(ë°°ì¹˜ ì²˜ë¦¬)

## ë²Œí¬ ì—°ì‚° ì‹œ ì£¼ì˜ì  â­ï¸

- JPAëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ê°€ ì˜¬ë¼ê°€ ìˆë‹¤.
- **_ë²Œí¬ì—°ì‚°ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¬´ì‹œí•˜ê³  ë°”ë¡œ DBì— ì¿¼ë¦¬ë¥¼ ë‚ ë¦°ë‹¤._**
  - ğŸ‘‰ **_ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ DBê°€ ì„œë¡œ ë‹¤ë¥¸ ìƒíƒœ!_**
  

<br>

### ë²Œí¬ ì—°ì‚° í›„ ë‹¤ì‹œ ì¡°íšŒí•˜ëŠ” ìƒí™©

```java
@Test
@DisplayName("ìˆ˜ì • ë²Œí¬ ì—°ì‚°")
@Commit
void bulkUpdate() {

        // member1 = 10 -> DB member1
        // member2 = 20 -> DB member2
        // member3 = 30 -> DB member3
        // member4 = 40 -> DB member4
        long count = queryFactory
                .update(member)
                .set(member.username, "ë¹„íšŒì›")
                .where(member.age.lt(28))
                .execute();

        // 1 member1 = 10 -> 1 DB ë¹„íšŒì›
        // 2 member2 = 20 -> 2 DB ë¹„íšŒì›
        // 3 member3 = 30 -> 3 DB member3
        // 4 member4 = 40 -> 4 DB member4

        // ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ê°™ì€ ì—”í‹°í‹°ê°€ ìˆìœ¼ë©´, DBì—ì„œ ê°€ì ¸ì˜¨ ê²°ê³¼ë¥¼ ë²„ë¦°ë‹¤.
        List<Member> result = queryFactory
                .selectFrom(member)
                .fetch();

        for (Member memberElem : result) {
                System.out.println("memberElem = " + memberElem);
        }
}
```

```java
memberElem = Member(id=3, username=member1, age=10)
memberElem = Member(id=4, username=member2, age=20)
memberElem = Member(id=5, username=member3, age=30)
memberElem = Member(id=6, username=member4, age=40)
```

- ë²Œí¬ ì—°ì‚° ì´í›„ì— ë¶„ëª…íˆ DBì—ëŠ” "ë¹„íšŒì›"ìœ¼ë¡œ ë°˜ì˜ë˜ì—ˆë‹¤.
- ê·¸ëŸ¬ë‚˜ ì´í›„ SELECT ê²°ê³¼ ì¤‘ì—ì„œ ì´ë¯¸ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ìˆëŠ” ì—”í‹°í‹°ëŠ” ë²„ë¦¼ìœ¼ë¡œì¨ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ìƒíƒœê°€ ìœ ì§€ëœë‹¤.  
  - ì´ëŸ° í˜„ìƒì„ `REPEATABLE READ` ë¼ê³ í•œë‹¤.

<br>


### ë²Œí¬ ì—°ì‚° í›„ì—ëŠ” ë°˜ë“œì‹œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í•˜ì â­ï¸

```java
@Test
@DisplayName("ìˆ˜ì • ë²Œí¬ ì—°ì‚°")
@Commit
void bulkUpdate() {

  // member1 = 10 -> DB member1
  // member2 = 20 -> DB member2
  // member3 = 30 -> DB member3
  // member4 = 40 -> DB member4
  long count = queryFactory
          .update(member)
          .set(member.username, "ë¹„íšŒì›")
          .where(member.age.lt(28))
          .execute();

  em.flush();
  em.clear();

  // 1 member1 = 10 -> 1 DB ë¹„íšŒì›
  // 2 member2 = 20 -> 2 DB ë¹„íšŒì›
  // 3 member3 = 30 -> 3 DB member3
  // 4 member4 = 40 -> 4 DB member4

  // ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ê°™ì€ ì—”í‹°í‹°ê°€ ìˆìœ¼ë©´, DBì—ì„œ ê°€ì ¸ì˜¨ ê²°ê³¼ë¥¼ ë²„ë¦°ë‹¤.
  List<Member> result = queryFactory
          .selectFrom(member)
          .fetch();

  for (Member memberElem : result) {
      System.out.println("memberElem = " + memberElem);
  }
}
```

- ë²Œí¬ ì—°ì‚° ì´í›„ì—ëŠ” `em.flush()`, `em.clear()`ë¥¼ í†µí•´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í•˜ì.


<br>

## ê¸°ì¡´ ìˆ«ìì— ë”í•˜ê¸°, ê³±í•˜ê¸°

```java
@Test
@DisplayName("ê¸°ì¡´ ìˆ«ìì— -1 ë”í•˜ê¸°")
void bulkAdd() {
    long count = queryFactory
            .update(member)
            .set(member.age, member.age.add(-1))
            .execute();

    System.out.println("count = " + count);
}
```

- ê³±í•˜ê¸°ëŠ” `add()` ëŒ€ì‹  `multiply()` ë¥¼ ì´ìš©.

<br>


## ë²Œí¬ ì‚­ì œ

```java
@Test
@DisplayName("ë²Œí¬ ì‚­ì œ")
void bulkDelete() {
    long executedCount = queryFactory
            .delete(member)
            .where(member.age.gt(18))
            .execute();

    System.out.println("executedCount = " + executedCount);
}
```